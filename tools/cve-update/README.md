# CVE Feed Automation Tool

Automatically fetch font-related CVEs from the National Vulnerability Database (NVD) and generate signature files for the font analysis system.

## Features

- **Automated CVE Fetching**: Retrieves CVEs from NVD API v2.0
- **Smart Filtering**: Identifies font-related CVEs using keyword matching
- **Signature Generation**: Creates YAML signature files compatible with `font-analysis` crate
- **Rate Limiting**: Respects NVD API rate limits (5 req/30s without API key, 50 req/30s with key)
- **Incremental Updates**: Skips existing signatures to avoid duplicates

## Installation

Build the tool from the workspace root:

```bash
cargo build --release -p cve-update
```

The binary will be available at `target/release/cve-update`.

## Usage

### Basic Usage

Fetch CVEs from 2020 to present and generate signatures:

```bash
./target/release/cve-update
```

### Custom Year Range

Specify start and end years:

```bash
./target/release/cve-update --start-year 2020 --end-year 2024
```

### Custom Output Directory

Specify where to write signature files:

```bash
./target/release/cve-update --output /path/to/signatures
```

### Using NVD API Key

For higher rate limits (50 requests per 30 seconds instead of 5):

```bash
export NVD_API_KEY="your-api-key-here"
./target/release/cve-update
```

Or pass it directly:

```bash
./target/release/cve-update --api-key "your-api-key-here"
```

Get a free API key at: https://nvd.nist.gov/developers/request-an-api-key

### Dry Run

Preview what would be generated without writing files:

```bash
./target/release/cve-update --dry-run --verbose
```

### Full Options

```bash
CVE Feed Automation Tool

Usage: cve-update [OPTIONS]

Options:
  -o, --output <OUTPUT>        Output directory for signature files [default: crates/font-analysis/signatures]
      --start-year <START_YEAR> Start year for CVE search (inclusive) [default: 2020]
      --end-year <END_YEAR>    End year for CVE search (inclusive, use current year if not specified)
      --api-key <API_KEY>      NVD API key (optional, increases rate limit) [env: NVD_API_KEY]
      --dry-run                Dry run - don't write files, just print what would be done
  -v, --verbose                Verbose output
  -h, --help                   Print help
```

## How It Works

### 1. CVE Fetching

The tool queries the NVD API for CVEs published in the specified year range:
- Uses NVD API v2.0 endpoint: `https://services.nvd.nist.gov/rest/json/cves/2.0`
- Fetches CVEs in batches of 2,000 (NVD max)
- Handles pagination automatically

### 2. Filtering

CVEs are filtered using keyword matching against their descriptions. A CVE is considered font-related if it contains any of these keywords:
- `font`, `truetype`, `opentype`, `type1`, `cff`, `woff`, `ttf`, `otf`
- `freetype`, `harfbuzz`, `fontforge`
- `adobe font`, `postscript font`, `embedded font`
- `glyph`, `charstring`, `hinting`
- `font parsing`, `font rendering`

### 3. Signature Generation

For each font-related CVE, the tool generates a YAML signature file containing:
- **CVE ID**: Official CVE identifier
- **Description**: English description from NVD
- **Severity**: Derived from CVSS score (critical/high/medium/low)
- **Pattern**: Placeholder requiring manual review (see below)
- **References**: Links to NVD and other sources

Example generated signature:

```yaml
- cve_id: CVE-2025-27163
  description: "hmtx table length is smaller than required..."
  severity: high
  pattern:
    type: manual
    note: "This signature requires manual review and pattern definition..."
  references:
    - "https://nvd.nist.gov/vuln/detail/CVE-2025-27163"
```

### 4. Manual Review Required

⚠️ **IMPORTANT**: Generated signatures use placeholder patterns and require manual review!

After running the tool, you must:
1. Review each generated signature file
2. Analyze the CVE details to understand the vulnerability
3. Replace the `manual` pattern with a specific detection pattern
4. Test the signature against known vulnerable samples

Available pattern types (see `crates/font-analysis/src/signatures.rs`):
- `table_length_mismatch`: Compare lengths between two tables
- `glyph_count_mismatch`: Compare glyph counts from different sources
- `table_size_exceeds`: Check if table exceeds size limit
- `offset_out_of_bounds`: Verify offsets are within bounds
- `operator_sequence`: Match charstring operator sequences

Example manual pattern definition:

```yaml
pattern:
  type: table_length_mismatch
  table1: hmtx
  table2: hhea
  condition: "table1.length < 4 * table2.num_metrics"
```

## Integration with CI/CD

### GitHub Actions

Create `.github/workflows/cve-update.yml`:

```yaml
name: Weekly CVE Update

on:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC
  workflow_dispatch:     # Allow manual trigger

jobs:
  update-cves:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Run CVE update tool
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          cargo build --release -p cve-update
          ./target/release/cve-update --verbose

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: Update CVE signatures'
          title: 'Weekly CVE Signature Update'
          body: |
            Automated CVE signature update from NVD.

            ⚠️ **Manual review required** - Generated signatures use placeholder patterns.

            Please review each new signature file and update the pattern field with specific detection logic.
          branch: cve-update
          labels: security, automated
```

## Rate Limiting

The NVD API has rate limits:
- **Without API key**: 5 requests per 30 seconds
- **With API key**: 50 requests per 30 seconds

The tool automatically handles rate limiting:
- Waits 6 seconds between years (without API key)
- Waits 1 second between years (with API key)
- Additional 1-second delay between pagination requests

For large year ranges or frequent updates, using an API key is recommended.

## Troubleshooting

### Connection Errors

If you see connection errors:
```
Failed to fetch from NVD API: error sending request
```

- Check your internet connection
- Verify NVD API is operational: https://nvd.nist.gov/
- Try with `--verbose` to see detailed request information

### Rate Limit Errors

If you hit rate limits:
```
NVD API returned status: 403
```

- Wait 30 seconds and try again
- Use an API key for higher limits: `--api-key YOUR_KEY`
- Reduce the year range to fetch fewer CVEs

### No Font CVEs Found

If no CVEs are found:
```
Font-related CVEs: 0
```

- This may be expected for certain years with no font vulnerabilities
- Try expanding the keyword list in the source code if needed
- Use `--verbose` to see all CVEs being checked

## Development

### Running Tests

```bash
cargo test -p cve-update
```

### Adding New Keywords

Edit `FONT_KEYWORDS` in `src/main.rs`:

```rust
const FONT_KEYWORDS: &[&str] = &[
    "font",
    // ... add more keywords
];
```

### Modifying Signature Format

The signature format must match `crates/font-analysis/src/signatures.rs`. If you modify the signature structure:

1. Update both files to stay in sync
2. Update existing signature files to match new format
3. Run tests to ensure compatibility

## License

Same as parent project.
