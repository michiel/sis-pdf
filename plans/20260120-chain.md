# Chain Summarisation Plan

## Goal

Improve chain output to deduplicate similar chains, increase readability, and surface payload context (including decode failures and recovery).

## Scope

- Applies to chain rendering in report output and query output.
- Uses existing typed graph, findings, and decode metadata.
- No changes to detection heuristics or finding generation beyond summary metadata for chains.

## Requirements

- Deduplicate chains that are effectively identical.
- Replace `unknown` trigger/action/payload with best-effort classifications.
- Add payload metadata summaries even when decode fails.
- Keep output concise and consistent with existing report formatting.
- Maintain Australian English spelling.

## Non-Goals

- Rewriting chain discovery logic.
- Changing finding severities or scoring.
- Rendering work in other formats (SARIF/JSON) beyond adding optional metadata.

## Inputs and Data Sources

- Typed graph edges (trigger/action/payload classification).
- Findings list (kind, surface, objects, evidence).
- Decode metadata (filters, mismatches, recovered filters, lengths).
- Object graph (dict keys for action/JS/URI/XFA/EmbeddedFile).

## Proposed Approach

## Status

- Step 1: Complete
- Step 2: Complete
- Step 3: Complete
- Step 4: Complete
- Step 5: Complete
- Step 6: Complete

### 1) Build a chain signature for deduplication

- Normalise each chain into a signature tuple:
  - `trigger_type`, `action_type`, `payload_type`
  - sorted list of object refs (obj/gen) in chain
  - sorted list of finding kinds attached to chain
- Hash the tuple and group chains by signature.
- Keep one representative chain and aggregate:
  - `count`
  - `object_refs` (unique set)
  - `payload_refs` (unique set)
  - `finding_kinds` (unique set)

### 2) Classify trigger/action/payload types

- Derive from typed graph edges first.
- Fallback to object dict keys:
  - Trigger: `/OpenAction`, `/AA`, `/Trigger`, page events, annotation events.
  - Action: `/S /JavaScript`, `/S /URI`, `/S /Launch`, `/S /GoToR`, `/S /SubmitForm`.
  - Payload: `/JS`, `/URI` (javascript/data), `/XFA` script, embedded file stream.
- Keep `unknown` only if no signals exist.

### 3) Add payload summaries

- For decoded payload:
  - `payload.type` (string/stream/embedded/xfa)
  - `payload.decoded_len`, `payload.decode_layers`
  - `payload.preview` (bounded ASCII preview)
- For decode failures:
  - `stream.filters`, `decode.mismatch`, `decode.outcome`
  - `stream.length` (declared and actual if available)
- For recovery:
  - `decode.recovered_filters`
  - marker `payload.recovered=true`

### 4) Improve chain output text

- Path line:
  - `Trigger:/OpenAction -> Action:/JavaScript -> Payload:stream 13 0 (FlateDecode)`
- Nodes line:
  - `stream@13:0 (len=5286 filters=/FlateDecode)`
- Evidence line:
  - `findings: declared_filter_invalid@13 0, js_present@3 0`
- Narrative line:
  - Use templates for common paths (OpenAction -> JS -> Payload).
  - Fall back to generic text only when all types are unknown.

### 5) Optional grouping in output

- Group chains by trigger/action pair.
- Under each group, list payload variants and aggregate counts.

## Implementation Steps

1) Add chain signature builder and grouping logic in chain rendering module.
2) Add classification helper for trigger/action/payload types.
3) Extend chain summary metadata to include decode/recovery payload info.
4) Update report rendering to use grouped chains and new text formatting.
5) Update query output to include chain metadata and group counts.
6) Add tests for:
   - Deduplication (multiple identical chains -> one output with count).
   - Classification (known action keys and payload types).
   - Decode failure payload summary.
   - Recovery payload marker.

## Testing

- Add unit tests for chain signature grouping.
- Add integration tests with a fixture containing:
  - repeated action chains
  - mixed payload types
  - decode failure stream
  - recovered deflate stream

## Risks and Mitigations

- Risk: Over-aggressive deduplication hides important differences.
  - Mitigation: include object refs and finding kinds in signature.
- Risk: Classification mislabels action types.
  - Mitigation: prefer typed graph edges and only use dict keys as fallback.
- Risk: Larger output volume due to extra metadata.
  - Mitigation: keep previews bounded and optional.

## Open Questions

- JSON/SARIF outputs include chain grouping metadata (resolved).
- Chain grouping defaults to enabled with `--ungroup-chains` to disable (resolved).
