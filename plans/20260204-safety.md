# Safety Plan: Unwrap Elimination

**Date**: 2026-02-04  
**Scope**: Satisfy the AGENTS.md directive “No unsafe code, no unwraps” by methodically replacing unchecked `.unwrap()` calls inside the workspace `src/` directories.

The prior `Stage 2` work in `plans/20260204-quality-improvements.md` has been migrated here to avoid cluttering the higher-level quality plan. This document now owns the per-crate tracking of the remaining unwraps and their remediation schedule.

---

## Stage 1: Quick wins (Completed)

- [x] `crates/sis-pdf-detectors/src/` – resolved the three unwraps (cycle detection, spot colours and UTF-16 normalisation) with pattern matching and safe option handling; validated with `cargo test -p sis-pdf-detectors`.
- [x] `crates/js-analysis/src/` – replaced the regex capture `unwrap()` and the decoder bounds slice with guarded logic; `cargo test -p js-analysis --features js-sandbox` exercises the impacted paths.

## Stage 2: Production crates (In progress)

### `crates/sis-pdf-ml-graph`

- [ ] `src/lib.rs:121` – `sentinel_idx.unwrap()` should propagate an error when the sentinel vector is missing instead of panic.
- [ ] Additional `unwrap_or_else` sites (`paths.embedding_model`, `paths.graph_model`) are safe, but double-check that no `.unwrap()` slip-ups remain.

### `crates/sis-pdf-core`

- [ ] Replace the remaining unchecked `.unwrap()` calls that slipped through earlier reviews:
  - `src/rich_media.rs` (zlib encoder `.unwrap()`s)
  - `src/runner.rs` (Results from capture threads)
  - `src/model.rs` (serde serialization)
  - `src/org_export.rs` (asserts on optional paths)
  - `src/explainability.rs` (chrono/tempdir/serde helpers in tests and persistence)
  - `src/profiler.rs` (report handling)
  - `src/ir_enhanced.rs` (serde helpers)

### `crates/sis-pdf`

- [x] Replace key CLI unwraps that touch user inputs or output formatting:
  - `src/main.rs`: REPL `actual_pdf` resolution and batch report selection now return contextual `anyhow!` errors instead of `unwrap`/`expect`.
  - `src/commands/query.rs`: SWF metadata writes use `detected_version` so `version.unwrap()` is gone (JSON/test helpers still under review).
  - `src/commands/query/readable.rs`: Table builders continue to use guarded option handling; no new unwraps added.

### `crates/font-analysis`

- [ ] Remove the remaining `.unwrap()`s in configuration/fixture helpers:
  - `src/model.rs` (config round-trips, embedded signature helpers)
  - `src/signatures.rs` (registry loading from YAML/JSON)
  - `src/type1/eexec.rs` (hex-to-binary conversion helpers)
  - `src/dynamic/ttf_vm.rs` (VM stack operations and program execution wrappers)

## Stage 3: Verification & Monitoring

- [ ] After each crate finishes its replacements, rerun the crate's unit tests (`cargo test -p sis-pdf-core`, `cargo test -p sis-pdf`, `cargo test -p font-analysis`) to ensure no regression.
- [ ] Maintain the `plans/20260204-safety.md` checklist and keep the quality improvement plan pointed at this file until `rg -n '\\.unwrap\\(' crates/*/src/` returns zero hits.

---

**Success Criteria**: The safety plan explicitly documents every remaining `.unwrap()` call and each entry contains a concrete remediation path. Once every checkbox is ticked, update `plans/20260204-quality-improvements.md` to note that Stage 2 has been closed.
