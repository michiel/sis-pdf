# JS Analysis Safety Plan

**Date**: 2026-02-05  
**Scope**: Replace remaining `unsafe` sections in `crates/js-analysis` (Boa GC helpers and `NativeFunction::from_closure` wrappers) so the crate can tolerate a global `#![forbid(unsafe_code)]`.

1. **Map unsafe spots**
   * Inventory every `unsafe impl Trace` and `unsafe` block inside `dynamic.rs` and related helpers (e.g., `from_closure_with_captures` wrappers).
   * Document why each site requires unsafe today (typically: Boa GC capture contract or Trace impl).

2. **Refactor Trace implementations**
   * For each capture struct (`CallableCapture`, `ValueCapture`, etc.), provide safe helper macros or wrapper types that only expose safe APIs; this may mean moving the `custom_trace!`/`empty_trace!` calls into a separate module that is itself `unsafe`, then exporting safe constructors that keep `'static` lifetimes in check.
   * Explore whether Boaâ€™s macros can be replaced with `derive(Trace)` or manual implementations guarded by safe wrappers that isolate the `unsafe` keyword.

3. **Wrap NativeFunction creation**
   * Replace every `unsafe { NativeFunction::from_closure_with_captures(...) }` with a safe helper (e.g., `fn build_native<F, C>(captures: C, closure: F) -> JsResult<NativeFunction>` where the helper itself uses `unsafe` but is isolated behind a descriptive name).
   * Confirm all captures implement `Trace` and ensure the helper enforces that via trait bounds so callers never repeat `unsafe`.

4. **Validate and guard behavior**
   * Add unit tests that exercise the new helpers, confirm GC traces run, and ensure no compile-time regressions.
   * Re-run `cargo test -p js-analysis --features js-sandbox` and workspace clippy with `forbid`.

5. **Document coverage**
   * Note the safety rationale and helper usage in `plans/20260205-js-safe.md` and reference it from `AGENTS.md` compliance updates; record when the crate becomes `unsafe`-free.
