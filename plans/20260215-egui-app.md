# egui UI plan for sis

## Design Principles

1. **Triage-first** ‚Äî default view answers "is this malicious?" in under 3 seconds
2. **Everything is linked** ‚Äî findings ‚Üí objects ‚Üí graph nodes ‚Üí evidence are all cross-referenced and clickable
3. **Progressive disclosure** ‚Äî summary ‚Üí table ‚Üí detail ‚Üí raw bytes
4. **Keyboard-friendly** ‚Äî power users never need the mouse for common workflows
5. **Export-ready** ‚Äî any data view can be copied or exported
6. **CLI-faithful** ‚Äî GUI query semantics match CLI exactly; no silent divergence

## Analyst Workflow Phases

The UI is structured around how a security analyst actually works:

```
Drop PDF ‚Üí Triage (is it bad?) ‚Üí Investigate (how is it bad?) ‚Üí Extract (get IOCs/payloads) ‚Üí Report (share findings)
```

## Milestone Cuts

### Milestone 1 ‚Äî MVP (single PR target)

Delivers the triage and basic investigation workflow. All panels in this milestone share a single `WorkspaceContext` (one PDF at a time).

| Panel             | Scope                                                  |
|-------------------|--------------------------------------------------------|
| Findings Table    | Full: sort, filter, search, row selection              |
| Finding Detail    | Full: all collapsible sections                         |
| Metadata          | Full: document info, encryption, xref summary          |
| Object Inspector  | Basic: object list, dict view, stream decode (text only), clickable refs |
| Chains            | List view only (no flow diagram)                       |

**Not in MVP:** Graph viewer, hex viewer, command bar, multi-tab, keyboard shortcuts beyond arrow keys, flow diagram in chains.

### Milestone 2 ‚Äî Power User

| Feature           | Scope                                                  |
|-------------------|--------------------------------------------------------|
| Command bar       | WASM-safe query subset, autocomplete, result panel     |
| Hex/Evidence viewer | Hex+ASCII view, evidence span highlighting           |
| Object Inspector  | Stream hex view, extract/download, back/forward nav    |
| Chains            | Flow diagram sub-view                                  |
| Multi-tab         | Up to 3 PDFs with workspace switching                  |

### Milestone 3 ‚Äî Advanced

| Feature           | Scope                                                  |
|-------------------|--------------------------------------------------------|
| Graph viewer      | Force-directed layout, filtering, chain highlighting   |
| Multi-tab         | Extend to 5 PDFs with eviction                         |
| Keyboard shortcuts| Full shortcut set with WASM conflict handling          |
| Telemetry         | UI performance and analyst action hooks                |

## Startup

- Keep the start screen as-is (drop/upload PDF)
- Show a progress bar for uploading/processing
- Show scan duration when complete
- On error: show error message with file name, size, and reason (not a raw panic)

## Application Structure

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ File‚ñæ  [sample1.pdf] [sample2.pdf]           ‚öô  üåô/‚òÄ  ‚îÇ  ‚Üê top-bar
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ report.pdf ‚îÇ 482KB ‚îÇ v1.7 ‚îÇ 127 objs ‚îÇ 2C 5H 3M 1L 12I ‚îÇ 4‚õì ‚îÇ  ‚Üê workspace-top-bar
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ    ‚îÇ                                                    ‚îÇ
‚îÇ üìä ‚îÇ  ‚îå‚îÄ Findings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ Detail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ üîç ‚îÇ  ‚îÇ [C‚ñæ][H‚ñæ][M‚ñæ][L‚ñæ][I‚ñæ] üîé   ‚îÇ ‚îÇ JS_OBFUSC... ‚îÇ ‚îÇ
‚îÇ üìã ‚îÇ  ‚îÇ Sev Conf Kind    Surface   ‚îÇ ‚îÇ              ‚îÇ ‚îÇ
‚îÇ üîó ‚îÇ  ‚îÇ ‚ñà‚ñàC Cert js_obf  JavaScript‚îÇ ‚îÇ Description  ‚îÇ ‚îÇ
‚îÇ üì¶ ‚îÇ  ‚îÇ ‚ñà‚ñàH Strg launch  Actions   ‚îÇ ‚îÇ Evidence     ‚îÇ ‚îÇ
‚îÇ üåê ‚îÇ  ‚îÇ ‚ñà‚ñàM Prob xfa_sc  Forms     ‚îÇ ‚îÇ Objects [‚Üí]  ‚îÇ ‚îÇ
‚îÇ ‚ö° ‚îÇ  ‚îÇ                            ‚îÇ ‚îÇ Reader Impact‚îÇ ‚îÇ
‚îÇ    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ    ‚îÇ                                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ > query: findings --where "severity == 'Critical'"      ‚îÇ  ‚Üê command bar (M2)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Top Bar

- The egui.rs demo site is the template for this app
- Far left: "File.." menu with dropdown containing "Open file.." (opens drop/upload dialog)
- Center: PDF tab labels ‚Äî each open PDF adds a navigation item (max per milestone)
- Far right: settings icon, theme toggle (light/dark)
- Clicking a tab label switches the workspace to that PDF's context

## Workspace Top Bar

Always visible. Shows at a glance for the active PDF:

- Filename, file size, PDF version
- Object count, page count
- Severity breakdown as colored badges: `2C 5H 3M 1L 12I`
- Chain count with icon
- Scan duration
- ML verdict badge (if available): `MALICIOUS` / `SUSPICIOUS` / `BENIGN`

**Interaction:** Clicking a severity badge filters the findings table to that severity. Clicking chain count opens chains panel.

## Left Navigation Column

Narrow column with icon buttons to open workspace panels:

- Findings (default, opens on load)
- Chains
- Metadata
- Objects
- Graph (M3)
- Evidence/Hex (M2)

Each button opens a resizable, closeable window in the workspace. Multiple panels can be open simultaneously.

---

## Panel Specifications

### 1. Findings Table

Default panel. Sortable, filterable, searchable.

**Data contract:**

- **Input:** `Vec<Finding>` from `Report.findings`
- **Query source:** in-memory filter/sort over findings vec; no async I/O
- **Latency budget:** <16ms for filter/sort (single frame)
- **Empty state:** "No findings detected" with file summary stats
- **Error state:** N/A (findings are always present, may be empty vec)

**Columns:**

| Column     | Sortable | Notes                                              |
|------------|----------|----------------------------------------------------|
| Severity   | yes      | Color-coded badge (red/orange/yellow/blue/gray)    |
| Confidence | yes      | Certain ‚Üí Heuristic                                |
| Kind       | yes      | e.g. `js_obfuscation`, `launch_action`             |
| Surface    | yes      | Attack surface category                            |
| Title      | no       | Truncated, full on hover                           |
| Objects    | no       | Count of related objects, clickable                |

**Filters (top of table):**

- Severity toggles (C/H/M/L/I)
- Attack surface dropdown
- Confidence minimum slider
- Text search across kind + title + description
- "Has CVE" toggle
- "Auto-triggered" toggle (findings with `action_initiation == "automatic"`)

**Interactions:**

- Click row ‚Üí opens Detail panel for that finding
- Double-click row ‚Üí opens Detail panel AND highlights related objects in graph (if open, M3)
- Right-click ‚Üí context menu: "Show in graph" (M3), "Copy as JSON", "Filter to this kind"
- Multi-select (Shift+click) ‚Üí bulk operations (export selected)

### 2. Finding Detail Panel

Right sidebar or floating window. Shows full context for the selected finding.

**Data contract:**

- **Input:** single `Finding` by index into filtered findings vec
- **Query source:** direct field access, no I/O
- **Latency budget:** <16ms (single frame)
- **Empty state:** "Select a finding from the table" placeholder
- **Error state:** N/A

**Sections (collapsible):**

- **Header:** Severity + Confidence badges, Kind, Surface, Title
- **Description:** Full finding description text
- **Evidence:** Each `EvidenceSpan` shown with:
  - Label and description
  - Hex/text preview of the evidence bytes (inline, truncated to 256 bytes)
  - "View in hex viewer" link ‚Üí opens Evidence panel at that offset (M2)
- **Related Objects:** List of object IDs, each clickable ‚Üí opens Object Inspector
- **Chain Membership:** If this finding is part of a chain, show the chain with this finding highlighted
- **Reader Impacts:** Table of Reader ‚Üí Version ‚Üí Impact Level ‚Üí Notes
- **CVE References:** Linked CVE IDs (clickable ‚Üí open in browser on native, show details on WASM)
- **Remediation:** If present, show recommended action
- **Metadata:** Key-value pairs from `meta` HashMap
- **YARA:** If present, show matching rule name and tags

### 3. Exploit Chains Panel

Dedicated view for chain analysis.

**Data contract:**

- **Input:** `Vec<ExploitChain>` from `Report.chains`
- **Query source:** in-memory sort; chain‚Üífinding lookup via `chain.findings` IDs matched against `Report.findings`
- **Latency budget:** <16ms for list view; flow diagram layout may take up to 100ms on first render
- **Empty state:** "No exploit chains detected"
- **Error state:** N/A

**List view (M1)** ‚Äî table of chains sorted by score:

| Score | Trigger    | Action     | Payload    | Findings | Path                              |
|-------|------------|------------|------------|----------|-----------------------------------|
| 0.95  | OpenAction | JavaScript | heap_spray | 3        | Catalog‚ÜíOpenAction‚ÜíJS‚ÜíStream      |

**Flow view (M2)** ‚Äî visual representation of selected chain as a horizontal flow diagram:

```
[Trigger: OpenAction] ‚îÄ‚îÄ‚Üí [Action: JavaScript] ‚îÄ‚îÄ‚Üí [Payload: heap_spray]
     obj 1 0                    obj 8 0                  obj 12 0
```

Each node is clickable ‚Üí opens Object Inspector.

**Interactions:**

- Select chain ‚Üí highlights its nodes in the ORG graph (if open, M3)
- Click finding ID in chain ‚Üí jumps to that finding in the Findings table
- "Explain chain" button ‚Üí shows `reasons` in a tooltip/panel
- Group chains by `group_id` with expand/collapse

### 4. Object Inspector

Browse and inspect individual PDF objects.

**Data contract:**

- **Input:** `ObjectGraph` from the parsed PDF (held in `AnalysisResult`)
- **Query source:** `ObjectGraph.objects` for listing; `ObjectGraph.index` for ID lookup; `OrgGraph.enhanced_nodes` for roles; `Report.findings` filtered by `finding.objects` for related findings
- **Latency budget:** object list render <16ms (virtualized); stream decode may take up to 500ms for large streams (show spinner)
- **Empty state:** "Select an object from the list" placeholder in detail pane
- **Error state:** "Failed to decode stream" with filter chain info and raw fallback

**Layout:** Object tree/list on the left, object detail on the right.

**Object list:**

- All objects listed by ID
- Filterable by type (Page, Action, Stream, Font, Image, etc.)
- Searchable by object ID

**Object detail (for selected object):**

- Object ID (num, gen)
- Type classification
- Dictionary view: key-value pairs, with reference values clickable
- Stream content (if present):
  - Decoded view (text/hex toggle; M1 text only, M2 adds hex)
  - Raw view (M2)
  - Filter chain info (e.g., FlateDecode ‚Üí ASCIIHexDecode)
  - Length, entropy
- **References to this object:** which objects reference this one
- **References from this object:** what this object references
- **Findings on this object:** list of findings mentioning this object ID
- **Roles:** from ORG graph (JsContainer, UriTarget, etc.)

**Interactions:**

- Click reference ‚Üí navigates to that object (M2 adds back/forward navigation stack)
- Click finding ‚Üí opens Detail panel
- "Show in graph" ‚Üí highlights in ORG graph (M3)
- "Extract stream" ‚Üí downloads decoded stream content (WASM: browser download, native: file save dialog) (M2)
- "Copy as JSON" ‚Üí copies object dict to clipboard

### 5. Metadata Panel

PDF document metadata and structural info.

**Data contract:**

- **Input:** `Report.structural_summary`, `Report.temporal_signals`, `Report.temporal_snapshots`, plus `ObjectGraph` xref data
- **Query source:** direct field access; xref sections from `ObjectGraph.xref_sections` and `ObjectGraph.deviations`
- **Latency budget:** <16ms (all data is pre-computed)
- **Empty state:** show fields as "N/A" or "not present" ‚Äî metadata is always partially available
- **Error state:** N/A

**Sections:**

- **Document Info:** Creator, Producer, Title, Author, Subject, Keywords, CreationDate, ModDate
- **PDF Version** and feature flags
- **Encryption:** Status, algorithm, key length, permissions
- **Page Count** with page size info
- **XRef Summary:**
  - Number of xref sections (indicates incremental updates)
  - Startxref positions
  - Deviations detected (with severity)
- **Revision Timeline:** Visual timeline of incremental updates if multiple revisions exist, showing what changed in each revision
- **Temporal Signals:** If available ‚Äî creation/modification patterns, timezone analysis
- **Supply Chain Indicators:** Tool chain detection from metadata

**Interactions:**

- Click deviation ‚Üí shows finding if one exists
- Revision timeline entries are expandable to show objects added/modified/deleted

### 6. ORG Graph Viewer (M3)

Interactive directed graph visualization of the PDF Object Reference Graph.

**Data contract:**

- **Input:** `OrgGraph` from `Report` (nodes, adjacency, enhanced_nodes, enhanced_edges)
- **Query source:** graph data is fully materialized; layout is computed client-side on open
- **Latency budget:** initial layout up to 2s for graphs <500 nodes (show progress); interactions <16ms after layout
- **Empty state:** "No object graph available" (shouldn't happen for valid PDFs)
- **Error state:** "Graph too large to render (N nodes)" with option to filter first
- **Hard cap:** refuse to layout graphs >2000 nodes without filtering; show message with suggested filters

**Rendering:**

- Force-directed or hierarchical layout (analyst choice)
- Nodes colored by type (Page=blue, Action=red, Stream=green, Font=gray, etc.)
- Suspicious edges drawn in red/dashed
- Edge labels showing relationship type
- Node labels showing obj ID + type

**Navigation:**

- Pan and zoom (scroll wheel + drag)
- Click node ‚Üí select, show info tooltip
- Double-click node ‚Üí open in Object Inspector
- Minimap in corner for large graphs

**Filtering:**

- Filter by node type (show only Actions + Streams)
- Filter by edge type (show only suspicious edges)
- "Show only chain path" ‚Äî filter to nodes/edges in a selected chain
- Depth slider ‚Äî show only N hops from selected node

**Highlighting:**

- When a finding is selected in Findings table, highlight related objects in graph
- When a chain is selected, highlight its path
- Search for object ID ‚Üí center and highlight

**Layout controls:**

- Reset layout
- Toggle labels
- Toggle edge labels
- Export as SVG/PNG (native) or screenshot (WASM)

**Performance:**

- For large graphs (1000+ nodes), use level-of-detail rendering
- Cluster by page or by type for large documents
- Lazy load edges on zoom
- Limit to 500 visible nodes at once with expand-on-demand

### 7. Evidence / Hex Viewer (M2)

Raw data viewer for evidence inspection.

**Data contract:**

- **Input:** byte slice (from object stream decode or raw file bytes) + list of `EvidenceSpan` ranges to highlight
- **Query source:** stream bytes from `ObjectGraph`; evidence offsets from `Finding.evidence`
- **Latency budget:** <16ms per visible page (virtualized); initial seek to offset <50ms
- **Empty state:** "No data to display" (e.g., stream decode yielded zero bytes)
- **Error state:** "Failed to read bytes at offset N" with context

**Features:**

- Hex view with ASCII sidebar (classic hex editor layout)
- Highlight regions corresponding to evidence spans
- Multiple evidence spans shown as colored overlays
- Offset navigation (jump to byte offset)
- Search within raw content
- Text/Hex/Both view toggle
- "Decode as" dropdown: UTF-8, UTF-16, ASCII, Base64, hex-escaped

**Entry points:**

- Click "view evidence" on a finding ‚Üí opens hex viewer at that offset
- Click "view raw" on an object stream ‚Üí shows decoded stream bytes
- From command bar: `stream 8 0 --raw` output ‚Üí hex view

### 8. Command Bar (M2)

Bottom-anchored command input, always accessible. Persistent command bar (like VS Code's command palette or browser dev tools console).

**Data contract:**

- **Input:** query string from user input
- **Query source:** dispatched through the same `Query` enum used by the CLI (`crates/sis-pdf/src/commands/query.rs`); GUI wraps the same execution path
- **Latency budget:** query parse <1ms; most queries <100ms; stream decode queries may take up to 500ms (show spinner)
- **Empty state:** prompt with placeholder text showing example query
- **Error state:** "Unknown query: ..." or "Query failed: ..." inline below input

**UI:**

- Single-line input with autocomplete
- Results appear in a slide-up panel (resizable)
- History with up/down arrow
- Tab completion for query names and fields

**Canonical query names (matching CLI exactly):**

- `object <num> [gen]` (aliases: `obj`, `o`) ‚Äî inspect object
- `stream <num> [gen] [--raw|--hexdump|--decode]` ‚Äî view stream
- `ref <num> [gen]` (alias: `references`) ‚Äî find references
- `findings`, `findings.critical`, `findings.high`, `findings.medium`, `findings.low`, `findings.info`
- `findings.kind <kind>`, `findings.composite`, `findings.count`
- `pages`, `objects.count`, `objects.list`, `objects.with <type>`
- `creator`, `producer`, `title`, `created`, `modified`, `version`, `filesize`, `encrypted`
- `javascript`, `javascript.count`, `urls`, `urls.count`
- `embedded`, `embedded.count`
- `chains`, `chains.count`
- `org.dot`, `org.json`, `ir.text`, `ir.json`
- Format switching: `:json`, `:yaml`, `:readable`, `:text`
- Predicate filtering: `:where severity == 'High'`

**Not available on WASM (grayed out with tooltip explaining why):**

- Shell piping (`|`) ‚Äî no shell access in browser
- File redirection (`>`) ‚Äî replaced by browser download
- `--extract-to` ‚Äî replaced by browser download

**GUI-specific commands (not in CLI):**

- `goto <num> [gen]` ‚Üí open Object Inspector for that object
- `graph focus <num> [gen]` ‚Üí center graph on object (M3)
- `highlight chain:<id>` ‚Üí highlight chain in graph (M3)
- `export report` ‚Üí trigger report download

**Results rendering:**

- Tables render as actual sortable tables
- JSON renders with syntax highlighting
- DOT export renders inline as a mini graph preview

---

## Cross-Panel Linking

All panels are interconnected via a shared selection/state bus (`WorkspaceContext`). Cross-panel links use stable identifiers: finding index, object `(num, gen)` pair, chain ID string.

| From                    | Action              | Opens / Highlights               | Milestone |
|-------------------------|---------------------|----------------------------------|-----------|
| Findings table row      | click               | Detail panel                     | M1        |
| Findings table row      | double-click        | Detail panel + graph highlight   | M3        |
| Detail panel object ID  | click               | Object Inspector                 | M1        |
| Detail panel evidence   | "view in hex"       | Evidence/Hex viewer at offset    | M2        |
| Detail panel chain      | click               | Chains panel, chain selected     | M1        |
| Chain flow node         | click               | Object Inspector                 | M2        |
| Chain selection         | auto                | Graph highlights chain path      | M3        |
| Object Inspector ref    | click               | Object Inspector (navigates)     | M1        |
| Object Inspector finding| click               | Detail panel                     | M1        |
| Object Inspector        | "show in graph"     | Graph centers on object          | M3        |
| Graph node              | double-click        | Object Inspector                 | M3        |
| Graph node              | click               | Info tooltip                     | M3        |
| Summary severity badge  | click               | Findings table filtered          | M1        |
| Summary chain count     | click               | Chains panel                     | M1        |
| Command bar `goto`      | enter               | Object Inspector                 | M2        |
| Command bar `graph focus`| enter              | Graph centers on object          | M3        |

**State bus design:** All cross-panel navigation writes to `WorkspaceContext` fields (`selected_finding`, `selected_object`, `selected_chain`, `graph_focus`). Panels read from these fields each frame. No direct panel-to-panel calls. This prevents drift and ensures any panel can be closed/reopened without breaking links.

---

## Native vs WASM Compatibility Matrix

| Capability              | Native                    | WASM                          | Notes                                    |
|-------------------------|---------------------------|-------------------------------|------------------------------------------|
| File open               | rfd file dialog           | Browser file input API        | Both already implemented                 |
| File size limit          | None (system memory)      | 50 MB                        | Hardcoded in `analysis.rs`               |
| Object cap              | None                      | 250,000                      | Hardcoded in `analysis.rs`               |
| Decode budget           | None                      | 64 MB per stream, 256 MB total| Hardcoded in `analysis.rs`               |
| Scan timeout            | TimeoutChecker            | None (no timeout in GUI yet)  | **Gap: needs adding for WASM**           |
| Deep scan               | Available                 | Disabled                      | `deep: false` in GUI                     |
| Parallel scan           | Available                 | Disabled                      | `parallel: false`, no rayon in WASM      |
| Shell piping            | Available                 | Unavailable                   | No shell in browser                      |
| File export             | File save dialog          | Browser download              | Via `<a>` download trigger               |
| Clipboard               | System clipboard          | `navigator.clipboard` API     | Needs async on WASM                      |
| Time                    | `std::time`               | `web_time` crate              | Already abstracted in `time_compat.rs`   |
| CVE link click          | Opens system browser      | Opens in new tab              | `window.open` on WASM                    |
| Keyboard shortcuts      | Direct key capture        | Must avoid browser conflicts  | See keyboard section                     |
| Thread spawning         | `std::thread`             | Not available                 | All compute is main-thread on WASM       |

---

## Browser Security Guardrails

Hard limits enforced before and during analysis on WASM targets. These are already partially implemented in `analysis.rs` but need surfacing in the UI.

| Guardrail                 | Limit           | UI Behavior                                          |
|---------------------------|-----------------|------------------------------------------------------|
| File size                 | 50 MB           | Reject with message before upload completes          |
| Object count              | 250,000         | Abort scan, show "PDF too complex" with object count |
| Per-stream decode         | 64 MB           | Skip stream, mark as "[decode budget exceeded]"      |
| Total decoded bytes       | 256 MB          | Stop decoding remaining streams, show warning        |
| Recursion depth           | 50              | Abort with "recursive structure detected"            |
| Scan timeout              | 30s (to add)    | Abort scan, show partial results with warning banner |
| Graph render node cap     | 2,000           | Refuse render, prompt to apply filters first         |
| Hex viewer max load       | 1 MB at a time  | Paginated lazy load                                  |
| Object list render        | 10,000 visible  | Virtualized; beyond this show "filter to narrow"     |

**Error surfacing:** All limit violations show as a non-dismissable warning banner at the top of the workspace (below workspace-top-bar) with the specific limit hit and a suggested action. Partial results are shown when available.

---

## State Management

Each PDF tab has its own independent `WorkspaceContext`:

- `AnalysisResult` (report, findings, chains, org graph)
- `selected_finding: Option<usize>` ‚Äî index into filtered findings
- `selected_object: Option<(u32, u16)>` ‚Äî obj num + gen
- `selected_chain: Option<String>` ‚Äî chain ID
- `graph_focus: Option<(u32, u16)>` ‚Äî object to center in graph
- Active filters (severity, surface, confidence, search text)
- Sort state (column, direction)
- Open panels and their positions/sizes
- Graph viewport (pan, zoom)
- Command bar history (`Vec<String>`, capped at 100)
- Object Inspector navigation stack (back/forward, `Vec<(u32, u16)>`)

The app holds a `Vec<WorkspaceContext>` and an `active_tab: usize`.

### Memory Pressure and Eviction (M2+)

- Each `WorkspaceContext` holds the full `AnalysisResult` including the parsed `ObjectGraph`. For a 50 MB PDF with 250k objects, this can consume ~200-400 MB.
- **Max concurrent tabs:** 3 in M2, 5 in M3 (native only for 5; WASM stays at 3)
- **Eviction policy (WASM only):** When opening a 4th PDF, the least-recently-viewed tab is evicted. Eviction drops the `ObjectGraph` and decoded streams but retains the `Report` (findings, chains, summary). Evicted tabs show a "Re-scan to restore full data" banner. The user can also manually close tabs.
- **Native:** No eviction; system memory is the limit. Tabs can be closed manually.
- **Memory indicator:** Show approximate memory usage in settings panel (WASM: `performance.memory` API if available).

---

## Keyboard Shortcuts

### Browser Conflict Handling (WASM)

Single-letter shortcuts (`F`, `C`, `G`, `O`, `M`, `1-5`) are only active when no text input has focus. On WASM, shortcuts that conflict with browser defaults are remapped:

| Conflict             | Resolution                                      |
|----------------------|-------------------------------------------------|
| `Ctrl+O` (browser open) | Use `Ctrl+Shift+O` on WASM                  |
| `Ctrl+1..5` (browser tabs) | Use `Alt+1..5` on WASM                   |
| `Ctrl+K` (browser URL bar) | Use `Ctrl+Shift+K` on WASM               |
| `Ctrl+Shift+C` (dev tools) | Use `Ctrl+Alt+C` on WASM                 |

Single-letter shortcuts are suppressed when an egui text input widget has focus (check `ctx.memory().focus()` before consuming keys).

### Shortcut Table

| Key (native)     | Key (WASM)        | Action                                         | Milestone |
|------------------|-------------------|-------------------------------------------------|-----------|
| `Ctrl+O`         | `Ctrl+Shift+O`    | Open file                                      | M1        |
| `Ctrl+1..5`      | `Alt+1..5`        | Switch to PDF tab 1-5                          | M2        |
| `Ctrl+K`         | `Ctrl+Shift+K`    | Focus command bar                              | M2        |
| `F`              | `F`               | Open/focus Findings                            | M3        |
| `C`              | `C`               | Open/focus Chains                              | M3        |
| `G`              | `G`               | Open/focus Graph                               | M3        |
| `O`              | `O`               | Open/focus Object Inspector                    | M3        |
| `M`              | `M`               | Open/focus Metadata                            | M3        |
| `Esc`            | `Esc`             | Close active panel / clear filter              | M1        |
| `‚Üë/‚Üì`            | `‚Üë/‚Üì`             | Navigate findings table                        | M1        |
| `Enter`          | `Enter`           | Open detail for selected finding               | M1        |
| `Ctrl+Shift+C`   | `Ctrl+Alt+C`     | Copy selected finding as JSON                  | M2        |

---

## Telemetry Hooks (M3)

Lightweight, opt-in instrumentation for tuning UI performance and understanding analyst behavior. No external reporting ‚Äî metrics are logged to console (native) or available via a debug panel.

**Performance metrics:**

- Frame time (p50, p95, p99) per panel ‚Äî detect jank
- Query execution duration (command bar)
- Graph layout duration
- Stream decode duration
- Time from file drop to first findings render

**Analyst action events:**

- Panel open/close (which panels, how often)
- Query frequency and which queries
- Finding selection patterns (how many findings inspected per session)
- Filter usage (which filters, how often)
- Cross-panel navigation (which links are clicked most)
- Session duration (time from first PDF open to tab close)

**Implementation:** A simple `TelemetryLog` struct with `Vec<TelemetryEvent>` in `SisApp`, append-only, capped at 1000 events. Viewable via settings/debug panel or `telemetry` command bar query.

---

## Workflows

### Workflow 1: Quick Triage (< 30 seconds)

1. Drop PDF
2. See summary bar ‚Üí "2 Critical, 5 High" + ML verdict badge
3. Click Critical badge ‚Üí findings filtered to Critical
4. Scan titles ‚Üí "JavaScript heap spray detected", "OpenAction automatic execution"
5. Decision: escalate / quarantine / safe

### Workflow 2: Exploit Chain Investigation (2-5 min)

1. Drop PDF ‚Üí see "4 chains" in summary bar
2. Open Chains panel ‚Üí sort by score
3. Select highest-scoring chain ‚Üí see flow: Trigger(OpenAction) ‚Üí Action(JavaScript) ‚Üí Payload(heap_spray)
4. Click payload node ‚Üí Object Inspector shows decoded JavaScript
5. Open ORG graph ‚Üí chain path highlighted (M3)
6. Trace through graph to understand object relationships
7. Click evidence on JS finding ‚Üí hex viewer shows obfuscated code (M2)

### Workflow 3: IOC Extraction (1-3 min)

1. After investigation, extract indicators
2. Command bar: `urls` ‚Üí see all URLs in document (M2)
3. Command bar: `javascript` ‚Üí see all JavaScript, click "Extract" to download
4. Command bar: `embedded` ‚Üí list embedded files with types and hashes
5. Select findings ‚Üí "Copy as JSON" ‚Üí paste into SIEM/ticketing system
6. Command bar: `export report` ‚Üí download full JSON report

### Workflow 4: PDF Structure Analysis (forensic deep-dive)

1. Open Metadata panel ‚Üí check Creator/Producer for known exploit kit signatures
2. Check revision timeline ‚Üí see if incremental updates added suspicious objects
3. Open Object Inspector ‚Üí browse objects by type
4. Filter to Action objects ‚Üí check for OpenAction, AA entries
5. Follow references through object graph
6. Open ORG graph ‚Üí filter to suspicious edges only (M3)
7. Command bar: `canonical-diff` ‚Üí compare revisions (M2)
8. Command bar: `cycles` ‚Üí check for reference cycles (common evasion) (M2)

### Workflow 5: Multi-PDF Comparison (M2+)

1. Open PDF A (tab 1), Open PDF B (tab 2)
2. Switch between tabs comparing:
   - Same creator/producer metadata?
   - Similar JavaScript patterns?
   - Same embedded file hashes?
   - Same exploit chain structure?
3. Tab switching enables manual comparison (true side-by-side diff is a future feature)

---

## Acceptance Criteria

### Milestone 1 ‚Äî MVP

| Item                | Done when...                                                                             |
|---------------------|------------------------------------------------------------------------------------------|
| Findings Table      | All 6 columns render; sorting by any sortable column works; all severity filter toggles work; text search filters in <16ms for 500 findings; row click opens detail |
| Finding Detail      | All sections render for a finding with evidence, reader impacts, CVEs, and meta; empty optional sections are hidden not broken; object IDs are clickable and open Object Inspector |
| Metadata Panel      | All Document Info fields render (or show "N/A"); xref summary shows section count and deviation count; encryption status shown |
| Object Inspector    | Object list renders all objects with virtualized scroll; type filter works; selecting an object shows dict key-values; reference values are clickable and navigate; stream content shows decoded text; findings on object are listed |
| Chains (list)       | Chain table renders with all columns; sorting by score works; clicking finding ID navigates to findings table |
| Cross-panel links   | All M1 links in the cross-panel table work bidirectionally                                |
| Error states        | File >50MB rejected with message (WASM); scan failure shows error not panic; empty findings shows placeholder |
| Build targets       | `cargo build` (native) and `trunk build` (WASM) both succeed; app runs in both           |

### Milestone 2 ‚Äî Power User

| Item                | Done when...                                                                             |
|---------------------|------------------------------------------------------------------------------------------|
| Command bar         | All canonical query names execute and produce output matching CLI; autocomplete suggests query names; history works with up/down; unknown query shows error inline; WASM-unavailable features are grayed out |
| Hex/Evidence viewer | Hex+ASCII renders for any byte slice; evidence span highlighting shows colored overlay at correct offsets; offset jump works; view stays responsive for 1MB+ streams via lazy loading |
| Object Inspector+   | Stream hex view toggle works; extract/download triggers native save dialog or browser download; back/forward navigation stack works |
| Chains flow         | Flow diagram renders trigger‚Üíaction‚Üípayload with clickable nodes; nodes open Object Inspector |
| Multi-tab (3)       | 3 PDFs open simultaneously; tab switching preserves all state; eviction works on WASM when opening 4th |

### Milestone 3 ‚Äî Advanced

| Item                | Done when...                                                                             |
|---------------------|------------------------------------------------------------------------------------------|
| Graph viewer        | Force-directed layout renders for graphs <500 nodes in <2s; pan/zoom/click/double-click work; chain highlighting works; node type filter works; graphs >2000 nodes show filter prompt |
| Multi-tab (5)       | 5 tabs on native; WASM stays at 3 with eviction                                          |
| Keyboard shortcuts  | All shortcuts in table work on native; WASM remappings work; no conflicts with browser defaults; shortcuts suppressed during text input |
| Telemetry           | Frame time and query duration logged; debug panel shows event log; capped at 1000 events  |

---

## Risk Mitigations

| Risk                    | Mitigation                                                                            |
|-------------------------|---------------------------------------------------------------------------------------|
| **Scope creep**         | Strict milestone cuts; MVP ships without graph/hex/command bar; each milestone is a separate PR |
| **Performance stall**   | Hard caps on graph nodes (2000), hex viewer page size (1MB), object list virtualization; latency budgets per panel enforced during review |
| **Cross-panel drift**   | Shared state bus via `WorkspaceContext` fields; no direct panel-to-panel calls; stable IDs (finding index, obj num+gen, chain ID string) |
| **Command bar divergence** | GUI command bar dispatches through the same `Query` enum as CLI; canonical names verified against `query.rs`; no GUI-only aliases for existing CLI commands |
| **User trust (CLI parity)** | Query output format matches CLI output; GUI-specific commands are clearly separate and prefixed differently; grayed-out WASM features explain why |
| **Memory pressure**     | Tab eviction policy; WASM decode budget; memory indicator in settings; max concurrent tabs |

---

## Performance Guardrails

- **Findings table:** Virtualized scrolling for 100+ findings (egui `ScrollArea` with row recycling)
- **Object list:** Same virtualization for PDFs with 100k+ objects; type filter reduces render set
- **Graph:** Level-of-detail rendering; collapse clusters beyond zoom threshold; hard cap at 2000 nodes pre-filter; limit to 500 visible nodes with expand-on-demand
- **Hex viewer:** Lazy loading ‚Äî only render visible byte range; 1 MB page size
- **Command bar results:** Paginated, max 100 results shown with "load more"
- **Stream decode:** Show spinner for operations >100ms; abort and show error for operations >5s


---

# M3: Advanced egui GUI Implementation

## Stages

### Stage 1: Telemetry + Multi-Tab 5
**Status**: Complete

- Created `src/telemetry.rs`: `TelemetryLog` (capped VecDeque<1000>), `TelemetryEvent`, `TelemetryEventKind`, rolling frame-time percentiles (p50/p95/p99 over 300-frame window)
- Created `src/panels/telemetry_debug.rs`: debug panel showing frame times, session duration, recent events
- Updated `src/workspace.rs`: conditional `MAX_TABS` (5 native, 3 WASM)
- Updated `src/app.rs`: added `telemetry`, `show_telemetry`, `elapsed_time` fields; records frame time each update
- Updated `src/panels/nav.rs`: added "Debug" toggle
- Updated `src/lib.rs`: added `pub mod telemetry`
- Tests: 6 unit tests (cap at 1000, percentile math, session duration, rolling window)

### Stage 2: Graph Data Model + Layout Engine
**Status**: Complete

- Created `src/graph_data.rs`: `GraphData`, `GraphNode`, `GraphEdge`, `GraphError`; builders `from_object_data`, `from_object_data_filtered`, `from_object_data_depth`; hard cap at 2000 nodes; suspicious edge heuristic
- Created `src/graph_layout.rs`: `LayoutState` with incremental Fruchterman-Reingold; deterministic spiral initial positions; O(n^2) repulsion
- Tests: 6 graph_data tests + 6 graph_layout tests (build, cap, filter, depth, suspicious edges, convergence, finite positions)

### Stage 3: Graph Viewer Panel
**Status**: Complete

- Created `src/panels/graph.rs`: `GraphViewerState`, egui `Painter` rendering, pan/zoom, click/double-click, node colours by type, suspicious edges in red, toolbar with type filter/depth slider/chain-only/labels/reset
- Updated `src/app.rs`: added `show_graph`, `graph_state`, `selected_chain` fields with save/restore in tab switch
- Updated `src/workspace.rs`: added graph fields to `WorkspaceContext`
- Updated `src/panels/nav.rs`: added "Graph" toggle
- Made `chains::extract_obj_ref_from_text` public for reuse in graph chain highlighting

### Stage 4: Keyboard Shortcuts
**Status**: Complete

- Created `src/shortcuts.rs`: `handle_shortcuts(ctx, app)` with modifier shortcuts (Ctrl+O, Ctrl+K, Ctrl+1..5, Ctrl+Shift+C), WASM remappings (Ctrl+Shift+O, Alt+1..5, etc.), single-letter shortcuts (F/C/G/O/M), arrow navigation, Esc priority chain
- Extracted testable helpers: `handle_escape`, `advance_finding_selection`, `copy_finding_json`
- Wired into `app.rs` update loop

### Stage 5: Cross-Panel Integration + Polish
**Status**: Complete

- Added `Query::GraphFocus` and `Query::HighlightChain` to `src/query.rs` with parser and executor
- Updated `src/panels/command_bar.rs` to handle graph focus/highlight commands
- Added telemetry events to `handle_file_drop` (FileOpened) and `switch_tab` (TabSwitched)
- Added "Show in graph" button to `src/panels/objects.rs`
- Added chain selection in `src/panels/chains.rs` for graph highlighting
- Updated `query_names()` for autocomplete
- Tests: 4 new query parse tests (graph focus, highlight chain, invalid cases)

## New Files

| File | Lines | Purpose |
|------|-------|---------|
| `src/telemetry.rs` | ~170 | Telemetry infrastructure |
| `src/graph_data.rs` | ~230 | Graph data model |
| `src/graph_layout.rs` | ~165 | Force-directed layout engine |
| `src/panels/graph.rs` | ~400 | Graph viewer panel |
| `src/panels/telemetry_debug.rs` | ~90 | Telemetry debug panel |
| `src/shortcuts.rs` | ~200 | Keyboard shortcut handler |

## Test Summary

- 36 unit tests (16 new: 6 telemetry, 6 graph_data, 6 graph_layout, 4 query parse) -- all passing
- 26 integration tests -- all passing
- 0 clippy warnings from new code

---

# Cleanup

Files in crates/sis-pdf-gui/dist/ have previously been put under version control. as a final cleanup we have to squash the commits in this branch to ensure these do not go to main
