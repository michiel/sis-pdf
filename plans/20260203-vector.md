# 20260203 Vector content detection plan

## Context

PDF vector graphics (path operators, embedded AI/EPS/SVG converted to native PDF drawing instructions, colour/gradient spaces) fall through the current raster-centric pipelines. The existing detection stack focuses on filters (JPEG/JPEG2000/PNG/TIFF/JBIG2) and HTML/JS payloads, but malicious delivery chains can also hide payloads in complex path graphs (e.g., bogus Bézier combinations, embedded scripts inside form XObjects, suspicious inline colour spaces). We briefly raised this gap while refreshing the image-analysis support for recent codec versions.

Treating vector content as an attack surface requires parsing content streams, tracking the drawing operator mix, and flagging suspect vectors (repeated `c`/`l`/`re` usage, tiny coordinate outputs, abnormal inline clip shading, etc.) or vector containers (embedded SVG/EPS). Instead of introducing a top-level `vector-analysis` crate, we can reuse our `sis-pdf-core` model/graph infrastructure and add the new detector alongside the existing ones, because vector detection needs the object graph and content streams already provided by `sis-pdf-core::graph`. This keeps the feature closer to the PDF parsing core and allows reuse of existing `Finding`/`Chain` utilities.

## Goals

1. Add a `vector_graphics` detector that scans content streams for suspicious path-heavy constructs and possibly embedded vector assets (SVG/EPS).
2. Populate metadata (operators, colour spaces, bounding boxes) so the finding can feed into your chain synth and narrative layers.
3. Ensure the detector integrates with existing scanning phases (`sis-pdf-core` detectors) without requiring a new crate boundary.

## Proposed steps

1. **Plan detection heuristics**  
   * Identify likely malicious indicators: very high operator counts, repeated `re`/`c` (`curveto`), tiny scaling (e.g., difference between bbox and page size), inline shading that embeds `/ColorSpace` dictionaries with Spot/Indexed entries, invisible vectors (`K 1`/`k 1` with almost zero width).  
   * Decide whether to treat embedded SVG/EPS (wrapped in `/Metadata`,/`/PieceInfo`, or `/Stream` with `/Subtype /XML` etc.) as vector findings or rely on existing textual detectors.
   * Determine how to surface these indicators as `Finding` fields: severity/impact, `meta` entries for operator counts, colour space usage, bounding boxes, and evidence spans.

2. **Implement content-stream parser extension**  
   * The parser should reuse the `sis-pdf-core::graph` object traversal. Add a helper that decodes a stream (using existing `decode_stream_with_meta` helpers) and then iterates over PDF path operators (via `sis_pdf_pdf::content::{Content, ContentOps}`).  
   * Construct metrics: total operator count, proportion of `c`/`l`/`re` vs `m`/`h`, number of inline `gs` (graphic state) references to Spot/Indexed colour spaces, path area vs page area ratio.  
   * Make the parser resilient to encrypted/filtered streams by relying on `sis_pdf_pdf`’s decoder (already available in `sis-pdf-core`).

3. **Signal findings**  
   * If thresholds cross (e.g., >500 path operators, >30% of ops are `c`/`re`, bounding box area <1% of page area but repeated many times), emit `vector_path_anomaly` with severity `Medium`/`High`, confidence derived from operator ratio.  
   * Include `meta`: `vector.op_count`, `vector.path_ratio`, `vector.spot_colors`, `vector.inline_js` (if `/JS` operators detected). Provide evidence spans referencing the content stream and the suspicious operators.
   * Support embedded SVG/EPS detection by checking for `/Type /Metadata` with XML payloads; reuse existing text heuristics (maybe share `payload_from_obj`) to check for `<svg`/`<!DOCTYPE svg>`.

4. **Chain integration & documentation**  
   * Mark the finding as an “Action”/“Payload” node when it directly links to embed layers; integrate with `chain_synth` labels for better narratives.  
   * Document the new capability in `docs/sis-pdf-spec.md` and `docs/findings.md` to explain why vector paths might be suspicious.

5. **Testing**  
   * Add unit tests in `crates/sis-pdf-core/tests/vector.rs` (new file) with generated streams (simple `m l h` sequences) to ensure detection thresholds behave.  
   * Add regression fixture (small PDF) to `crates/sis-pdf-core/tests/fixtures` demonstrating vector anomalies and ensure `sis explain` surfaces the new finding.

## Technical considerations

- No new crate is needed; the detector lives inside `crates/sis-pdf-core/src/detectors` (similar to `rs` file).  
- Reuse existing decode helpers to avoid re-implementing filter handling.  
- Ensure the new detection integrates cleanly with feature gating (vector detection always on, but may rely on optional filters handled in image module).  
- Consider parallelizing stream processing only if required (content streams are already decoded via `sis-pdf-core`).

## Implementation status

- [x] Drafted heuristics and parser approach relying on `sis-pdf-core` stream decoding.
- [x] Added the `vector_graphics` detector, new parser operators, and metadata wiring inside `sis-pdf-detectors`.
- [x] Documented the new finding in the spec and findings catalog, and added regression heuristics/unit tests.

## Next steps

- Monitor `vector_graphics_anomaly` hits for acceptable noise vs signal and adjust thresholds if needed.
