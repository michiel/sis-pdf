name: quality-gates

on:
  pull_request:
  workflow_dispatch:

jobs:
  uplift-gates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install GUI build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev libxi-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libxkbcommon-dev libwayland-dev libgl1-mesa-dev \
            xvfb x11-apps imagemagick mesa-utils desktop-file-utils

      - name: Core schema and chain gates
        run: |
          cargo test -p sis-pdf-core --test report_schema_compat
          cargo test -p sis-pdf-core --test chain_grouping
          cargo test -p sis-pdf-core --test uplift_synthetic_fixtures
          cargo test -p sis-pdf-core --test corpus_captured_regressions \
            corpus_captured_modern_openaction_staged_baseline_stays_stable \
            -- --nocapture
          cargo test -p sis-pdf-core --test corpus_captured_regressions \
            corpus_captured_modern_renderer_revision_baseline_stays_stable \
            -- --nocapture
          cargo test -p sis-pdf-core --test corpus_captured_regressions \
            corpus_captured_modern_gated_supply_chain_baseline_stays_stable \
            -- --nocapture
          cargo test -p sis-pdf-core --test corpus_captured_regressions \
            corpus_captured_manifest_integrity_stays_stable \
            -- --nocapture

      - name: GUI budget gates
        run: |
          cargo test -p sis-pdf-gui graph_layout_staged_dag_budget -- --nocapture
          cargo test -p sis-pdf-gui critical_path_budget -- --nocapture
          cargo test -p sis-pdf-gui taint_overlay_mapping_budget -- --nocapture
          cargo test -p sis-pdf-gui --no-default-features --test image_preview_pipeline -- --nocapture
          cargo test -p sis-pdf-gui --no-default-features --test analysis \
            on_demand_image_preview_generation_from_analysis_result \
            -- --nocapture

      - name: CLI diff budget gate
        run: |
          cargo test -p sis-pdf diff_large_input_budget -- --nocapture
          cargo test -p sis-pdf format_json_and_jsonl_keep_stable_top_level_keys -- --nocapture

      - name: Runtime profile SLO gate
        run: |
          cargo run -p sis-pdf --bin sis -- scan \
            crates/sis-pdf-core/tests/fixtures/actions/launch_cve_2010_1240.pdf \
            --deep \
            --runtime-profile \
            --runtime-profile-format json \
            2> runtime-profile.json
          parse_ms=$(jq '[.phases[] | select(.name=="parse")][0].duration_ms // 0' runtime-profile.json)
          detect_ms=$(jq '[.phases[] | select(.name=="detection")][0].duration_ms // 0' runtime-profile.json)
          slow_detector_count=$(jq '[.detectors[] | select((.duration_ms // 0) > 20)] | length' runtime-profile.json)
          echo "parse_ms=${parse_ms}"
          echo "detection_ms=${detect_ms}"
          echo "slow_detector_count=${slow_detector_count}"
          test "${parse_ms}" -le 10
          test "${detect_ms}" -le 50
          test "${slow_detector_count}" -eq 0

      - name: WASM GUI build gate
        run: cargo build -p sis-pdf-gui --target wasm32-unknown-unknown

      - name: Native GUI screenshot smoke gate
        run: |
          mkdir -p tmp/gui-smoke
          attempt=1
          while [ "${attempt}" -le 3 ]; do
            echo "GUI smoke attempt ${attempt}/3"
            if SIS_GUI_SMOKE_SKIP_BUILD=1 ./scripts/gui_smoke.sh tmp/gui-smoke; then
              exit 0
            fi
            rc=$?
            # Exit code 10 indicates screenshot assertions failed; do not retry.
            if [ "${rc}" -eq 10 ]; then
              exit "${rc}"
            fi
            if [ "${attempt}" -eq 3 ]; then
              exit "${rc}"
            fi
            attempt=$((attempt + 1))
            sleep 2
          done

      - name: Upload GUI smoke artefacts
        if: failure()
        uses: actions/upload-artifact@v7
        with:
          name: gui-smoke-artifacts
          path: tmp/gui-smoke
          if-no-files-found: ignore

      - name: Linux desktop metadata validation
        run: desktop-file-validate packaging/linux/sis.desktop

  gui-native-cross-build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build native GUI target
        run: cargo build -p sis-pdf-gui
