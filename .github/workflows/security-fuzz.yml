name: security-fuzz

on:
  pull_request:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 4 * * 1'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  cargo-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo audit
        run: cargo audit

  fuzz-smoke:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-fuzz
        run: cargo +nightly install cargo-fuzz --locked

      - name: Run parser fuzz smoke
        working-directory: fuzz
        run: cargo +nightly fuzz run parser -- -max_total_time=20

      - name: Run image metadata fuzz smoke
        working-directory: fuzz
        run: cargo +nightly fuzz run image_metadata -- -max_total_time=20

      - name: Run Do-chain recursion fuzz smoke
        working-directory: fuzz
        run: cargo +nightly fuzz run do_chain_recursion -- -max_total_time=10

      - name: Run inline-image parser fuzz smoke
        working-directory: fuzz
        run: cargo +nightly fuzz run inline_image_parse -- -max_total_time=10

      - name: Run Type3 charproc fuzz smoke
        working-directory: fuzz
        run: cargo +nightly fuzz run type3_charproc -- -max_total_time=10
